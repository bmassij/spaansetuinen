const fs = require('fs');
const path = require('path');

// This script now reads hero-mapping.json generated by the classification step.
// It expects values to be web-relative paths like "assets/impressie/other1.jpg".
const HERO_JSON = path.join(__dirname, 'hero-mapping.json');

// Patterns to replace or insert hero overlay
const oldPatterns = [
  /<div class="absolute inset-0 overflow-hidden">\s*<img[^>]*>\s*<\/div>/g,
  /<div class="absolute inset-0"[^>]*><\/div>/g
];

function updateHeroImage(filename, imagePath) {
  const filepath = path.join(__dirname, filename);
  if (!fs.existsSync(filepath)) {
    console.log(`‚ö†Ô∏è  Bestand niet gevonden: ${filename}`);
    return false;
  }

  let content = fs.readFileSync(filepath, 'utf-8');
  const hasHeroSection = content.includes('<header') && content.includes('bg-gradient-to-br');
  if (!hasHeroSection) {
    console.log(`‚ö†Ô∏è  Geen hero section gevonden in: ${filename}`);
    return false;
  }

  // Normalize slashes for HTML
  const webPath = imagePath.replace(/\\/g, '/').replace(/^demo-html-css\//, '').replace(/^\.\//, '');
  const newOverlay = `<div class="absolute inset-0 opacity-40" style="background-image:url('${webPath}'); background-size:cover; background-position:center;"></div>`;

  let updated = false;
  for (const pattern of oldPatterns) {
    if (pattern.test(content)) {
      content = content.replace(pattern, newOverlay);
      updated = true;
      break;
    }
  }

  if (!updated) {
    const headerMatch = content.match(/(<header[^>]*>)/);
    if (headerMatch) {
      const headerTag = headerMatch[1];
      const insertPos = content.indexOf(headerTag) + headerTag.length;
      content = content.slice(0, insertPos) + '\n    ' + newOverlay + content.slice(insertPos);
      updated = true;
    }
  }

  if (updated) {
    fs.writeFileSync(filepath, content, 'utf-8');
    console.log(`‚úì Updated: ${filename} ‚Üí ${webPath}`);
    return true;
  } else {
    console.log(`‚úó Kon niet updaten: ${filename}`);
    return false;
  }
}

function main() {
  if (!fs.existsSync(HERO_JSON)) {
    console.log('Hero mapping not found:', HERO_JSON);
    process.exit(1);
  }

  const mapping = JSON.parse(fs.readFileSync(HERO_JSON, 'utf-8'));
  console.log('üöÄ Updating hero images using', HERO_JSON, '\n');

  let success = 0;
  let total = 0;

  for (const [page, img] of Object.entries(mapping)) {
    total++;
    if (updateHeroImage(page, img)) success++;
  }

  console.log(`\n‚úÖ Completed: ${success}/${total} pages updated`);
}

main();
